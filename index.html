<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JIT Admin ‚Äî Temporary Access Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }
    html,body{ height:100%; }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .bg-grid {
      background-image: radial-gradient(ellipse at top, rgba(79,70,229,.25), transparent 60%),
                        radial-gradient(ellipse at bottom, rgba(59,130,246,.25), transparent 60%);
    }
  </style>
</head>
<body class="min-h-full bg-slate-950 text-slate-100 bg-grid">
  <!-- Navbar -->
  <header class="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-slate-950/50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 grid place-items-center rounded-xl bg-indigo-500/20 ring-1 ring-indigo-400/30">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v18"/><path d="M5 9l7-6 7 6"/><path d="M5 15l7 6 7-6"/>
          </svg>
        </div>
        <span class="font-semibold tracking-tight">JIT Admin</span>
        <span class="text-xs text-slate-400 border border-slate-700 rounded-md px-2 py-0.5">5‚Äëminute role</span>
      </div>
      <a id="linkGithub" href="#" class="text-slate-300 hover:text-white text-sm">View Source</a>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-10">
    <!-- Hero Card -->
    <section class="grid lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 rounded-2xl p-6 bg-slate-900/70 ring-1 ring-slate-800 shadow-2xl shadow-black/40">
        <h1 class="text-2xl font-semibold">üîê Just‚ÄëIn‚ÄëTime Admin Access</h1>
        <p class="mt-1 text-slate-400">Click <span class="font-medium text-slate-200">Request Admin</span> to receive a short‚Äëlived JWT with <code class="px-1.5 py-0.5 bg-slate-800 rounded">roles:['admin']</code>. It expires automatically in 5 minutes (or revoke any time).</p>

        <!-- Request form -->
        <div class="mt-6 grid md:grid-cols-12 gap-3 items-end">
          <label class="md:col-span-4">
            <span class="text-sm text-slate-300">Username</span>
            <input id="user" type="text" placeholder="alice" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </label>
          <label class="md:col-span-4">
            <span class="text-sm text-slate-300">Reason (optional)</span>
            <input id="reason" type="text" placeholder="Rotate secret" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </label>
          <label class="md:col-span-4">
            <span class="text-sm text-slate-300">Approver (optional)</span>
            <input id="approver" type="text" placeholder="manager@corp" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </label>
          <div class="md:col-span-8 flex gap-3 mt-2 md:mt-0">
            <button id="req" class="px-4 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 transition text-white font-medium">Request Admin (5 min)</button>
            <button id="revoke" class="px-4 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition">Revoke now</button>
          </div>
        </div>

        <!-- Status -->
        <div class="mt-6 grid sm:grid-cols-2 gap-6">
          <div class="p-4 rounded-xl bg-slate-900/70 border border-slate-800">
            <div class="text-sm text-slate-400">Session</div>
            <div class="mt-2 flex flex-wrap items-center gap-2" aria-live="polite">
              <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">User: <b id="who" class="text-slate-200 font-medium">‚Äî</b></span>
              <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">Roles: <b id="roles" class="text-slate-200 font-medium">‚Äî</b></span>
              <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">Reason: <b id="claimReason" class="text-slate-200 font-medium">‚Äî</b></span>
              <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">Approver: <b id="claimApprover" class="text-slate-200 font-medium">‚Äî</b></span>
            </div>
          </div>
          <div class="p-4 rounded-xl bg-slate-900/70 border border-slate-800 flex items-center gap-4">
            <svg class="shrink-0" width="84" height="84" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="52" fill="none" stroke="rgb(30 41 59)" stroke-width="12" />
              <circle id="ring" cx="60" cy="60" r="52" fill="none" stroke="rgb(99 102 241)" stroke-width="12" stroke-linecap="round" stroke-dasharray="326.72" stroke-dashoffset="326.72"/>
            </svg>
            <div>
              <div class="text-sm text-slate-400">Expires in</div>
              <div id="left" class="text-3xl font-semibold tabular-nums">‚Äî</div>
              <div id="statusBadge" class="mt-1 text-xs text-emerald-300">No active admin</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin action card -->
      <div class="rounded-2xl p-6 bg-slate-900/70 ring-1 ring-slate-800 shadow-2xl shadow-black/40">
        <h2 class="text-lg font-semibold">Admin‚Äëonly Action</h2>
        <p class="mt-1 text-slate-400">Proves server enforcement. Tries a protected endpoint that checks <span class="font-medium">roles.includes('admin')</span>.</p>
        <button id="adminAction" class="mt-4 w-full px-4 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 transition text-white font-medium">Rotate Secret (Demo)</button>
        <div id="actionMsg" class="mt-3 text-sm"></div>
        <div class="mt-6 text-xs text-slate-400">Tip: Try after expiry or after Revoke to see denial.</div>
      </div>
    </section>

    <!-- Audit log -->
    <section class="mt-8 rounded-2xl p-6 bg-slate-900/70 ring-1 ring-slate-800">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Audit (client‚Äëside demo)</h3>
        <button id="copyAudit" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs">Copy JSON</button>
      </div>
      <div class="mt-3 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="text-slate-400">
            <tr>
              <th class="text-left font-medium py-2 pr-4">Time</th>
              <th class="text-left font-medium py-2 pr-4">Event</th>
              <th class="text-left font-medium py-2 pr-4">Detail</th>
            </tr>
          </thead>
          <tbody id="auditRows" class="divide-y divide-slate-800"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Toasts -->
  <div id="toastHost" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const toastHost = $("#toastHost");
    const who = $("#who"), roles = $("#roles"), left = $("#left"), statusBadge=$("#statusBadge"), claimReason=$("#claimReason"), claimApprover=$("#claimApprover");
    const ring = $("#ring");
    const circumference = 2 * Math.PI * 52; // r=52

    let expMs = null, timer = null, audit = [];

    // Stop and clear the countdown interval
    function stopTimer() {
      if (timer) { clearInterval(timer); timer = null; }
    }

    function toast(text, kind = "info") {
      const colors = {
        info: "bg-slate-800 text-slate-100 border border-slate-700",
        ok: "bg-emerald-600 text-white",
        bad: "bg-rose-600 text-white"
      };
      const el = document.createElement("div");
      el.className = `px-3 py-2 rounded-lg shadow ${colors[kind]}`;
      el.textContent = text;
      toastHost.appendChild(el);
      setTimeout(() => el.remove(), 2600);
    }

    function setRing(remainingMs) {
      if (!expMs || remainingMs <= 0) {
        ring.style.strokeDashoffset = circumference;
        return;
      }
      const total = 5 * 60 * 1000; // 5 min
      const frac = Math.max(0, Math.min(1, remainingMs / total));
      ring.style.strokeDashoffset = circumference * (1 - frac);
    }

    function fmt(ms) {
      if (!ms || ms <= 0) return "expired";
      const s = Math.floor(ms/1000);
      const m = Math.floor(s/60);
      const r = s % 60;
      return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
    }

    function addAudit(event, detail) {
      const row = { t: new Date().toISOString(), event, detail };
      audit.unshift(row);
      renderAudit();
    }

    function renderAudit() {
      const host = $("#auditRows");
      host.innerHTML = audit.map(a => `
        <tr>
          <td class="py-2 pr-4 text-slate-300">${new Date(a.t).toLocaleTimeString()}</td>
          <td class="py-2 pr-4">${a.event}</td>
          <td class="py-2 pr-4 text-slate-300">${a.detail}</td>
        </tr>`).join("");
    }

    async function refresh() {
      try {
        const r = await fetch('/api/whoami', { cache: 'no-store' });
        const d = await r.json();
        who.textContent = d.user || '‚Äî';
        const roleList = (d.roles && d.roles.length) ? d.roles.join(', ') : '‚Äî';
        roles.textContent = roleList;
        claimReason.textContent = d.reason || '‚Äî';
        claimApprover.textContent = d.approver || '‚Äî';
        expMs = d.expiresAt;

        // If no active admin after refresh, stop timer and reset UI
        if (!expMs) {
          stopTimer();
          left.textContent = '‚Äî';
          setRing(0);
          statusBadge.textContent = 'No active admin';
          statusBadge.className = 'mt-1 text-xs text-emerald-300';
          return;
        }

        if (timer) clearInterval(timer);
        timer = setInterval(() => {
          const ms = (expMs ? expMs - Date.now() : 0);
          left.textContent = fmt(ms);
          setRing(ms);
          if (ms <= 0) {
            statusBadge.textContent = 'No active admin';
            statusBadge.className = 'mt-1 text-xs text-emerald-300';
          } else {
            statusBadge.textContent = 'Admin active';
            statusBadge.className = 'mt-1 text-xs text-indigo-300';
          }
        }, 1000);
      } catch (e) {
        who.textContent = '‚Äî'; roles.textContent = '‚Äî'; left.textContent = '‚Äî';
      }
    }

    $("#req").onclick = async () => {
      const user = $("#user").value.trim() || 'demo';
      const reason = $("#reason").value.trim();
      const approver = $("#approver").value.trim();
      const url = new URL(location.origin + '/api/request-admin');
      url.searchParams.set('user', user);
      if (reason) url.searchParams.set('reason', reason);
      if (approver) url.searchParams.set('approver', approver);
      const r = await fetch(url);
      const d = await r.json();
      expMs = d.expiresAt || null;
      addAudit('REQUEST_ADMIN', `${user} (${reason || 'no reason'})`);
      toast('Admin granted (5 min).', 'ok');
      await refresh();
    };

    $("#revoke").onclick = async () => {
      await fetch('/api/revoke', { cache: 'no-store' });
      expMs = null;
      stopTimer();
      left.textContent = '‚Äî';
      setRing(0);
      statusBadge.textContent = 'No active admin';
      statusBadge.className = 'mt-1 text-xs text-emerald-300';
      addAudit('REVOKE', 'manual');
      toast('Access revoked.', 'info');
      await refresh();
    };

    $("#adminAction").onclick = async () => {
      const el = $("#actionMsg");
      el.textContent = '‚Ä¶';
      const r = await fetch('/api/admin-action');
      const d = await r.json();
      if (d.ok) {
        el.innerHTML = `<span class="text-emerald-300">‚úÖ ${d.message}</span>`;
        addAudit('ADMIN_ACTION', 'success');
        toast('Admin action succeeded.', 'ok');
      } else {
        el.innerHTML = `<span class="text-rose-300">‚õî ${d.error || 'Denied'}</span>`;
        addAudit('ADMIN_ACTION', 'denied');
        toast('Denied. Not an admin or token expired.', 'bad');
      }
    };

    $("#copyAudit").onclick = async () => {
      await navigator.clipboard.writeText(JSON.stringify(audit, null, 2));
      toast('Audit JSON copied.', 'info');
    };

    // Init
    refresh();
  </script>
</body>
</html>
