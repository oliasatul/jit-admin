<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JIT Admin ‚Äî Okta/Auth0 Integration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Okta Auth JS (PKCE) -->
  <script src="https://global.oktacdn.com/okta-auth-js/7.6.3/okta-auth-js.umd.js"></script>
  <!-- Auth0 SPA SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
  <style>
    :root { color-scheme: dark; }
    html,body{ height:100%; }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .bg-grid {
      background-image: radial-gradient(ellipse at top, rgba(79,70,229,.25), transparent 60%),
                        radial-gradient(ellipse at bottom, rgba(59,130,246,.25), transparent 60%);
    }
    .test-pass{ color:#34d399 }
    .test-fail{ color:#f87171 }
  </style>
  <script>
    // ====== Optional inline config (leave blank to use /api/*-config env vars) ======
    // OKTA: Example issuer: https://dev-12345678.okta.com/oauth2/default
    window.OKTA_ISSUER = window.OKTA_ISSUER || "";       // e.g., "https://dev-xxx.okta.com/oauth2/default"
    window.OKTA_CLIENT_ID = window.OKTA_CLIENT_ID || ""; // e.g., "0oa1abcDEFgHij..."

    // AUTH0: Domain (your-tenant.us.auth0.com) and Client ID
    window.AUTH0_DOMAIN = window.AUTH0_DOMAIN || "";     // e.g., "your-tenant.us.auth0.com"
    window.AUTH0_CLIENT_ID = window.AUTH0_CLIENT_ID || ""; // e.g., "AbCdEf..."

    // Optional: namespaced claim that contains roles/groups in Auth0 ID token
    window.AUTH0_ROLES_CLAIM = window.AUTH0_ROLES_CLAIM || "https://example.com/roles";
  </script>
</head>
<body class="min-h-full bg-slate-950 text-slate-100 bg-grid">
  <!-- Navbar -->
  <header class="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-slate-950/50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 grid place-items-center rounded-xl bg-indigo-500/20 ring-1 ring-indigo-400/30">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v18"/><path d="M5 9l7-6 7 6"/><path d="M5 15l7 6 7-6"/>
          </svg>
        </div>
        <span class="font-semibold tracking-tight">JIT Admin</span>
        <span id="providerBadge" class="text-xs text-slate-400 border border-slate-700 rounded-md px-2 py-0.5">provider: ‚Äî</span>
      </div>
      <div class="flex items-center gap-3 text-sm">
        <button id="btnLogin" class="px-3 py-1.5 rounded-lg bg-sky-600 hover:bg-sky-500 disabled:opacity-50">Sign in</button>
        <button id="btnLogout" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 disabled:opacity-50" disabled>Sign out</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-10">
    <section class="grid lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 rounded-2xl p-6 bg-slate-900/70 ring-1 ring-slate-800 shadow-2xl shadow-black/40">
        <h1 class="text-2xl font-semibold">üîê Just‚ÄëIn‚ÄëTime Admin Access</h1>
        <p class="mt-1 text-slate-400">Sign in with <span id="idpName" class="font-medium text-slate-200">your IdP</span>, then click <span class="font-medium text-slate-200">Request Admin</span> to receive a short‚Äëlived JWT with <code class="px-1.5 py-0.5 bg-slate-800 rounded">roles:['admin']</code>. It expires in 5 minutes (or revoke any time).</p>

        <!-- Identity -->
        <div class="mt-4 p-4 rounded-xl bg-slate-900/70 border border-slate-800">
          <div class="text-sm text-slate-400">Identity</div>
          <div class="mt-2 flex flex-wrap items-center gap-2" aria-live="polite">
            <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">User: <b id="idpUser" class="text-slate-200 font-medium">Not signed in</b></span>
            <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">Email: <b id="idpEmail" class="text-slate-200 font-medium">‚Äî</b></span>
            <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">Groups/Roles: <b id="idpGroups" class="text-slate-200 font-medium">‚Äî</b></span>
          </div>
        </div>

        <!-- Request form -->
        <div class="mt-6 grid md:grid-cols-12 gap-3 items-end">
          <label class="md:col-span-4">
            <span class="text-sm text-slate-300">Username</span>
            <input id="user" type="text" placeholder="alice" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </label>
          <label class="md:col-span-4">
            <span class="text-sm text-slate-300">Reason (optional)</span>
            <input id="reason" type="text" placeholder="Rotate secret" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </label>
          <label class="md:col-span-4">
            <span class="text-sm text-slate-300">Approver (optional)</span>
            <input id="approver" type="text" placeholder="manager@corp" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </label>
          <div class="md:col-span-8 flex gap-3 mt-2 md:mt-0">
            <button id="req" class="px-4 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 transition text-white font-medium" disabled>Request Admin (5 min)</button>
            <button id="revoke" class="px-4 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition" disabled>Revoke now</button>
          </div>
        </div>

        <!-- Status -->
        <div class="mt-6 grid sm:grid-cols-2 gap-6">
          <div class="p-4 rounded-xl bg-slate-900/70 border border-slate-800">
            <div class="text-sm text-slate-400">Session</div>
            <div class="mt-2 flex flex-wrap items-center gap-2" aria-live="polite">
              <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">User: <b id="who" class="text-slate-200 font-medium">‚Äî</b></span>
              <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">Roles: <b id="roles" class="text-slate-200 font-medium">‚Äî</b></span>
              <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">Reason: <b id="claimReason" class="text-slate-200 font-medium">‚Äî</b></span>
              <span class="px-2 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm">Approver: <b id="claimApprover" class="text-slate-200 font-medium">‚Äî</b></span>
            </div>
          </div>
          <div class="p-4 rounded-xl bg-slate-900/70 border border-slate-800 flex items-center gap-4">
            <svg class="shrink-0" width="84" height="84" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="52" fill="none" stroke="rgb(30 41 59)" stroke-width="12" />
              <circle id="ring" cx="60" cy="60" r="52" fill="none" stroke="rgb(99 102 241)" stroke-width="12" stroke-linecap="round" stroke-dasharray="326.72" stroke-dashoffset="326.72"/>
            </svg>
            <div>
              <div class="text-sm text-slate-400">Expires in</div>
              <div id="left" class="text-3xl font-semibold tabular-nums">‚Äî</div>
              <div id="statusBadge" class="mt-1 text-xs text-emerald-300">No active admin</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin action card -->
      <div class="rounded-2xl p-6 bg-slate-900/70 ring-1 ring-slate-800 shadow-2xl shadow-black/40">
        <h2 class="text-lg font-semibold">Admin‚Äëonly Action</h2>
        <p class="mt-1 text-slate-400">Proves server enforcement. Tries a protected endpoint that checks <span class="font-medium">roles.includes('admin')</span>.</p>
        <button id="adminAction" class="mt-4 w-full px-4 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 transition text-white font-medium">Rotate Secret (Demo)</button>
        <div id="actionMsg" class="mt-3 text-sm"></div>
        <div class="mt-6 text-xs text-slate-400">Tip: Try after expiry or after Revoke to see denial.</div>
      </div>
    </section>

    <!-- Audit + Self-tests -->
    <section class="mt-8 rounded-2xl p-6 bg-slate-900/70 ring-1 ring-slate-800">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Audit (client‚Äëside demo)</h3>
        <div class="flex gap-2 items-center">
          <button id="copyAudit" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs">Copy JSON</button>
          <button id="runTests" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs">Run Self‚ÄëTests</button>
        </div>
      </div>
      <div class="mt-3 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="text-slate-400">
            <tr>
              <th class="text-left font-medium py-2 pr-4">Time</th>
              <th class="text-left font-medium py-2 pr-4">Event</th>
              <th class="text-left font-medium py-2 pr-4">Detail</th>
            </tr>
          </thead>
          <tbody id="auditRows" class="divide-y divide-slate-800"></tbody>
        </table>
      </div>
      <div class="mt-6">
        <h4 class="text-sm font-semibold text-slate-300">Self‚ÄëTest Results</h4>
        <ul id="testResults" class="mt-2 space-y-1 text-sm"></ul>
      </div>
    </section>
  </main>

  <!-- Toasts -->
  <div id="toastHost" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const toastHost = $("#toastHost");
    const who = $("#who"), roles = $("#roles"), left = $("#left"), statusBadge=$("#statusBadge"), claimReason=$("#claimReason"), claimApprover=$("#claimApprover");
    const idpUserEl=$("#idpUser"), idpEmailEl=$("#idpEmail"), idpGroupsEl=$("#idpGroups"), idpNameEl=$("#idpName"), providerBadge=$("#providerBadge");
    const ring = $("#ring");
    const circumference = 2 * Math.PI * 52; // r=52

    let expMs = null, timer = null, audit = [];

    function toast(text, kind = "info") {
      const colors = { info: "bg-slate-800 text-slate-100 border border-slate-700", ok: "bg-emerald-600 text-white", bad: "bg-rose-600 text-white" };
      const el = document.createElement("div"); el.className = `px-3 py-2 rounded-lg shadow ${colors[kind]}`; el.textContent = text; toastHost.appendChild(el); setTimeout(() => el.remove(), 2600);
    }
    function stopTimer(){ if (timer) { clearInterval(timer); timer = null; } }
    function setRing(remainingMs) { if (!expMs || remainingMs <= 0) { ring.style.strokeDashoffset = circumference; return; } const total = 5 * 60 * 1000; const frac = Math.max(0, Math.min(1, remainingMs / total)); ring.style.strokeDashoffset = circumference * (1 - frac); }
    function fmt(ms) { if (!ms || ms <= 0) return "expired"; const s = Math.floor(ms/1000); const m = Math.floor(s/60); const r = s % 60; return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`; }
    function addAudit(event, detail){ const row = { t: new Date().toISOString(), event, detail }; audit.unshift(row); renderAudit(); }
    function renderAudit(){ const host = $("#auditRows"); host.innerHTML = audit.map(a => `<tr><td class="py-2 pr-4 text-slate-300">${new Date(a.t).toLocaleTimeString()}</td><td class="py-2 pr-4">${a.event}</td><td class="py-2 pr-4 text-slate-300">${a.detail}</td></tr>`).join(""); }

    // ------- Config Fetchers -------
    async function getOktaConfig(){
      let issuer = window.OKTA_ISSUER; let clientId = window.OKTA_CLIENT_ID;
      if (!issuer || !clientId) {
        try { const r = await fetch('/api/okta-config', { cache: 'no-store' }); if (r.ok){ const j = await r.json(); issuer = issuer || j.issuer; clientId = clientId || j.clientId; } } catch {}
      }
      return { issuer, clientId };
    }
    async function getAuth0Config(){
      let domain = window.AUTH0_DOMAIN; let clientId = window.AUTH0_CLIENT_ID; let rolesClaim = window.AUTH0_ROLES_CLAIM || 'https://example.com/roles';
      if (!domain || !clientId) {
        try { const r = await fetch('/api/auth0-config', { cache: 'no-store' }); if (r.ok){ const j = await r.json(); domain = domain || j.domain; clientId = clientId || j.clientId; rolesClaim = j.rolesClaim || rolesClaim; } } catch {}
      }
      return { domain, clientId, rolesClaim };
    }

    // ------- Provider Abstraction -------
    const provider = { name: 'none', signedIn: false, signIn: async()=>{}, signOut: async()=>{}, handleRedirect: async()=>{}, getIdentity: async()=>({}) };
    let oktaAuth = null; let auth0Client = null; let rolesClaimNs = 'https://example.com/roles';

    async function initProvider(){
      // Try Okta first
      const oktaCfg = await getOktaConfig();
      const OktaAuthCtor = (window.OktaAuth||{}).OktaAuth;
      if (OktaAuthCtor && oktaCfg.issuer && oktaCfg.clientId) {
        const redirect = (window.location && window.location.origin) ? (window.location.origin + '/') : '/';
        oktaAuth = new OktaAuthCtor({ issuer: oktaCfg.issuer, clientId: oktaCfg.clientId, redirectUri: redirect, scopes: ['openid','profile','email','groups'], pkce: true, tokenManager: { storage: 'sessionStorage' }});
        provider.name = 'okta'; idpNameEl.textContent = 'Okta'; providerBadge.textContent = 'provider: Okta';
        provider.signIn = async ()=> oktaAuth.signInWithRedirect();
        provider.signOut = async ()=> { try{ await oktaAuth.signOut(); }catch{} };
        provider.handleRedirect = async ()=>{
          const hasParams = /[?&](code|state)=/.test(window.location.search);
          if (hasParams) { try { const { tokens } = await oktaAuth.token.parseFromUrl(); oktaAuth.tokenManager.setTokens(tokens); const url = new URL(window.location); url.search=''; history.replaceState({},'',url); } catch(e) { console.warn('Okta parse error', e);} }
          const { idToken } = await oktaAuth.tokenManager.getTokens();
          provider.signedIn = !!idToken;
          if (idToken) return { name: idToken.claims.name || idToken.claims.sub, email: idToken.claims.email, groups: idToken.claims.groups || [], raw: idToken.claims };
          return null;
        };
        provider.getIdentity = async ()=>{
          const { idToken } = await oktaAuth.tokenManager.getTokens();
          if (!idToken) return null;
          return { name: idToken.claims.name || idToken.claims.sub, email: idToken.claims.email, groups: idToken.claims.groups || [], raw: idToken.claims };
        };
        return provider;
      }
      // Fallback to Auth0
      const a0 = await getAuth0Config(); rolesClaimNs = a0.rolesClaim || rolesClaimNs;
      if (a0.domain && a0.clientId && window.createAuth0Client) {
        const redirect = (window.location && window.location.origin) ? (window.location.origin + '/') : '/';
        auth0Client = await window.createAuth0Client({ domain: a0.domain, clientId: a0.clientId, authorizationParams: { redirect_uri: redirect, scope: 'openid profile email' } });
        provider.name = 'auth0'; idpNameEl.textContent = 'Auth0'; providerBadge.textContent = 'provider: Auth0';
        provider.signIn = async ()=> auth0Client.loginWithRedirect();
        provider.signOut = async ()=> auth0Client.logout({ logoutParams: { returnTo: redirect } });
        provider.handleRedirect = async ()=>{
          if (window.location.search.includes('code=')) { try { await auth0Client.handleRedirectCallback(); const url=new URL(window.location); url.search=''; history.replaceState({},'',url); } catch(e) { console.warn('Auth0 parse error', e);} }
          const isAuth = await auth0Client.isAuthenticated(); provider.signedIn = isAuth;
          if (!isAuth) return null;
          const user = await auth0Client.getUser();
          const claims = await auth0Client.getIdTokenClaims();
          const groups = extractGroupsFromClaims(claims);
          return { name: user.name || user.nickname || user.sub, email: user.email || '‚Äî', groups, raw: claims };
        };
        provider.getIdentity = async ()=>{
          const isAuth = await auth0Client.isAuthenticated(); if (!isAuth) return null;
          const user = await auth0Client.getUser(); const claims = await auth0Client.getIdTokenClaims(); const groups = extractGroupsFromClaims(claims);
          return { name: user.name || user.nickname || user.sub, email: user.email || '‚Äî', groups, raw: claims };
        };
        return provider;
      }
      providerBadge.textContent = 'provider: ‚Äî';
      return provider;
    }

    function extractGroupsFromClaims(claims){
      if (!claims) return [];
      // Common places for roles/groups in Auth0
      const keys = Object.keys(claims);
      const direct = (claims.groups || claims.roles || claims.permissions) || [];
      if (Array.isArray(direct) && direct.length) return direct;
      // Namespaced claims ending with /groups or /roles
      const nsMatch = keys.find(k => /\/(groups|roles)$/i.test(k));
      if (nsMatch && Array.isArray(claims[nsMatch])) return claims[nsMatch];
      // Custom configured namespace
      if (claims[rolesClaimNs] && Array.isArray(claims[rolesClaimNs])) return claims[rolesClaimNs];
      return [];
    }

    async function refreshSessionUI(){
      try {
        const r = await fetch('/api/whoami', { cache: 'no-store' }); const d = await r.json();
        who.textContent = d.user || '‚Äî'; roles.textContent = (d.roles && d.roles.length) ? d.roles.join(', ') : '‚Äî';
        claimReason.textContent = d.reason || '‚Äî'; claimApprover.textContent = d.approver || '‚Äî';
        expMs = d.expiresAt;
        if (!expMs) { stopTimer(); left.textContent = '‚Äî'; setRing(0); statusBadge.textContent = 'No active admin'; statusBadge.className = 'mt-1 text-xs text-emerald-300'; return; }
        stopTimer();
        timer = setInterval(() => { const ms = (expMs ? expMs - Date.now() : 0); left.textContent = fmt(ms); setRing(ms); if (ms <= 0) { statusBadge.textContent = 'No active admin'; statusBadge.className = 'mt-1 text-xs text-emerald-300'; stopTimer(); } else { statusBadge.textContent = 'Admin active'; statusBadge.className = 'mt-1 text-xs text-indigo-300'; } }, 1000);
      } catch { who.textContent = '‚Äî'; roles.textContent = '‚Äî'; left.textContent = '‚Äî'; }
    }

    // ------- Wiring Buttons -------
    $("#btnLogin").onclick = async () => { if (provider.name==='none'){ toast('Configure Okta or Auth0 first.', 'bad'); return; } await provider.signIn(); };
    $("#btnLogout").onclick = async () => { if (provider.name==='none') return; try{ await provider.signOut(); }catch{} await onAuthStateChanged(); toast('Signed out.', 'info'); };

    $("#req").onclick = async () => {
      if (!provider.signedIn) { toast('Sign in first.', 'bad'); return; }
      const user = $("#user").value.trim() || 'demo'; const reason = $("#reason").value.trim(); const approver = $("#approver").value.trim();
      const params = new URLSearchParams(); params.set('user', user); if (reason) params.set('reason', reason); if (approver) params.set('approver', approver);
      const r = await fetch(`/api/request-admin?${params.toString()}`); const d = await r.json(); expMs = d.expiresAt || null;
      addAudit('REQUEST_ADMIN', `${user} (${reason || 'no reason'})`); toast('Admin granted (5 min).', 'ok'); await refreshSessionUI(); };

    $("#revoke").onclick = async () => { await fetch('/api/revoke', { cache: 'no-store' }); expMs = null; stopTimer(); left.textContent = '‚Äî'; setRing(0); statusBadge.textContent = 'No active admin'; statusBadge.className = 'mt-1 text-xs text-emerald-300'; addAudit('REVOKE', 'manual'); toast('Access revoked.', 'info'); await refreshSessionUI(); };

    $("#adminAction").onclick = async () => { const el = $("#actionMsg"); el.textContent = '‚Ä¶'; const r = await fetch('/api/admin-action'); const d = await r.json(); if (d.ok) { el.innerHTML = `<span class="text-emerald-300">‚úÖ ${d.message}</span>`; addAudit('ADMIN_ACTION', 'success'); toast('Admin action succeeded.', 'ok'); } else { el.innerHTML = `<span class="text-rose-300">‚õî ${d.error || 'Denied'}</span>`; addAudit('ADMIN_ACTION', 'denied'); toast('Denied. Not an admin or token expired.', 'bad'); } };

    $("#copyAudit").onclick = async () => { await navigator.clipboard.writeText(JSON.stringify(audit, null, 2)); toast('Audit JSON copied.', 'info'); };

    async function onAuthStateChanged(){
      const ident = await provider.handleRedirect();
      provider.signedIn = !!ident;
      if (ident){ $("#btnLogin").disabled = true; $("#btnLogout").disabled = false; $("#req").disabled = false; $("#revoke").disabled = false; idpUserEl.textContent = ident.name || '(no name)'; idpEmailEl.textContent = ident.email || '‚Äî'; idpGroupsEl.textContent = (ident.groups && ident.groups.length) ? ident.groups.slice(0,8).join(', ') + (ident.groups.length>8?'‚Ä¶':'') : '‚Äî'; }
      else { $("#btnLogin").disabled = false; $("#btnLogout").disabled = true; $("#req").disabled = true; $("#revoke").disabled = true; idpUserEl.textContent = 'Not signed in'; idpEmailEl.textContent = '‚Äî'; idpGroupsEl.textContent = '‚Äî'; }
    }

    // ------- Self‚Äëtests -------
    $("#runTests").onclick = async () => {
      const out = $("#testResults"); out.innerHTML = '';
      function li(msg, pass){ const li = document.createElement('li'); li.innerHTML = pass ? `‚úÖ <span class="test-pass">${msg}</span>` : `‚õî <span class="test-fail">${msg}</span>`; out.appendChild(li); }
      try { const r1 = await fetch('/api/whoami', { cache: 'no-store' }); const j1 = await r1.json(); li('whoami returns JSON', !!j1 && typeof j1 === 'object'); } catch { li('whoami returns JSON', false); }
      try { const p = new URLSearchParams({ user: 'test', reason: 'x', approver: 'y' }).toString(); const path = `/api/request-admin?${p}`; li('request-admin path constructed (relative URL)', /^\/api\/request-admin\?/.test(path)); } catch { li('request-admin path constructed (relative URL)', false); }
      li('provider detected', provider.name==='okta' || provider.name==='auth0');
    };

    // ------- Init -------
    (async function init(){
      await initProvider();
      await onAuthStateChanged();
      await refreshSessionUI();
    })();
  </script>
</body>
</html>
